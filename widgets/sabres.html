<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Buffalo Sabres — Live</title>
<style>
  :root{
    /* Buffalo Sabres theme */
    --sabres-navy: #002654;
    --sabres-gold: #FCB514;
    --sabres-white: #f7f9fc;
    --bg-deep: #001631;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    min-height:100vh;
    color:var(--sabres-white);
    background:
      radial-gradient(1200px 700px at 80% 10%, rgba(252,181,20,.12), transparent 60%),
      radial-gradient(900px 500px at 20% 80%, rgba(0,38,84,.35), transparent 70%),
      var(--bg-deep);
    font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
  }
  /* Full-bleed container */
  .wrap{
    max-width:none; width:100%;
    padding:28px clamp(16px, 3vw, 36px);
  }

  /* Score header */
  .scorebar{
    display:flex; align-items:center; justify-content:space-between;
    gap:18px; flex-wrap:wrap;
    background: linear-gradient(180deg, rgba(0,38,84,.85), rgba(0,28,62,.85));
    border: 2px solid rgba(252,181,20,.35);
    border-radius:18px;
    padding:18px 20px;
    box-shadow: 0 12px 30px rgba(0,0,0,.35);
  }
  .teams{
    display:grid; grid-template-columns: 1fr auto 1fr; align-items:center; gap:12px;
    flex:1 1 auto;
  }
  .team{
    display:flex; align-items:center; gap:12px;
    min-width:0;
  }
  .badge{
    width:44px; height:44px; border-radius:10px;
    background: linear-gradient(135deg, var(--sabres-gold), #ffd56a);
    outline: 3px solid rgba(0,38,84,.6);
  }
  .name{font-weight:700; letter-spacing:.2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .score{
    font-weight:800; font-size:2.1rem; padding:0 10px;
  }
  .meta{
    display:flex; flex-direction:column; align-items:flex-end; gap:4px;
    min-width:160px;
    color:#cfe1ff;
  }
  .state{font-weight:700}
  .pill{
    display:inline-block; font-size:.85rem; padding:4px 8px; border-radius:999px;
    background: rgba(252,181,20,.18); border:1px solid rgba(252,181,20,.35); color:#ffe9b3;
  }

  /* Goal list */
  .panel{
    margin-top:18px;
    background: linear-gradient(180deg, rgba(0,38,84,.72), rgba(0,28,62,.72));
    border: 1px solid rgba(252,181,20,.28);
    border-radius:16px; padding:14px 16px;
  }

  .panel h3{margin:6px 0 10px 0; font-size:1.05rem; color:#eaf2ff}
  .goals{display:grid; gap:10px}
  .goal{
    display:grid; grid-template-columns: 78px 1fr; gap:12px; align-items:baseline;
    padding:10px; border-radius:12px;
    background: rgba(255,255,255,.03);
    border:1px solid rgba(255,255,255,.06);
  }
  .time{font-weight:700; color:#ffe3a3}
  .who{font-weight:700}
  .assist{color:#c6d6f6}
  .sep{opacity:.35; padding:0 4px}

  @media (max-width:640px){
    .teams{grid-template-columns: 1fr; text-align:center}
    .meta{align-items:center}
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="scorebar" id="scorebar">
      <div class="teams">
        <div class="team" id="awayTeam">
          <div class="badge" aria-hidden="true"></div>
          <div class="name">Away</div>
        </div>
        <div class="score" id="score">0 — 0</div>
        <div class="team" id="homeTeam">
          <div class="badge" aria-hidden="true" style="background:linear-gradient(135deg,#ffd56a,var(--sabres-gold))"></div>
          <div class="name">Home</div>
        </div>
      </div>
      <div class="meta">
        <div class="state" id="state">Loading…</div>
        <div><span class="pill" id="when"></span></div>
      </div>
    </div>

    <div class="panel">
      <h3>Goals</h3>
      <div class="goals" id="goals">Fetching…</div>
    </div>
  </div>

  <script>
(async function(){
  const SABRES_ID = 7;
  const TZ = 'America/New_York';

  // ---- helpers ----
  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));

  // NYC-local YYYY-MM-DD (avoid UTC shifting)
  function nyDate(d=new Date()){
    const y = d.toLocaleString('en-CA', { timeZone: TZ, year:'numeric' });
    const m = d.toLocaleString('en-CA', { timeZone: TZ, month:'2-digit' });
    const day = d.toLocaleString('en-CA', { timeZone: TZ, day:'2-digit' });
    return `${y}-${m}-${day}`;
  }

  async function safeFetch(url, opt={}, retries=2, backoff=400){
    for (let i=0;i<=retries;i++){
      try{
        const r = await fetch(url, {cache:'no-store', ...opt});
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        return await r.json();
      }catch(e){
        if (i===retries) throw e;
        await sleep(backoff*(i+1));
      }
    }
  }

  // ---- primary: StatsAPI (with wide window) ----
  async function getGameViaStatsApi(){
    const now = new Date();
    const start = new Date(now); start.setDate(start.getDate()-14);
    const end   = new Date(now); end.setDate(end.getDate()+7);

    const url = `https://statsapi.web.nhl.com/api/v1/schedule?teamId=${SABRES_ID}` +
                `&expand=schedule.teams,schedule.linescore` +
                `&startDate=${nyDate(start)}&endDate=${nyDate(end)}`;

    const data = await safeFetch(url);
    const games = (data.dates||[]).flatMap(d=>d.games||[]);
    if (!games.length) return null;

    // choose most relevant: live > today > last finished > next scheduled
    const todayStr = nyDate(now);
    const live = games.find(g => (g.status?.abstractGameState||'').toLowerCase()==='live');
    if (live) return live;

    const today = games.find(g => g.gameDate && g.gameDate.startsWith(todayStr));
    if (today) return today;

    const finished = games.filter(g => (g.status?.detailedState||'').includes('Final'));
    if (finished.length) return finished[finished.length-1];

    return games[0];
  }

  // ---- fallback: api-web.nhle.com ----
  async function getGameViaApiWeb(){
    // scoreboard for local date; then filter sabres
    const url = `https://api-web.nhle.com/v1/score/${nyDate(new Date())}`;
    const data = await safeFetch(url);
    const games = data?.games || [];
    const cand = games.find(g => g.awayTeam?.id===SABRES_ID || g.homeTeam?.id===SABRES_ID);
    if (!cand) return null;

    // normalize to a shape similar to StatsAPI
    return {
      gamePk: cand.id,
      gameDate: cand.startTimeUTC,
      status: { detailedState: cand.gameState },
      teams: {
        away: { team: { name: cand.awayTeam?.placeName?.default + ' ' + cand.awayTeam?.commonName?.default }, score: cand.awayTeam?.score ?? 0 },
        home: { team: { name: cand.homeTeam?.placeName?.default + ' ' + cand.homeTeam?.commonName?.default }, score: cand.homeTeam?.score ?? 0 }
      },
      __apiweb: true
    };
  }

  // get live feed (statsapi) or api-web play-by-play fallback
  async function getLiveFeed(game){
    // StatsAPI preferred
    try{
      if (!game.__apiweb) {
        const url = `https://statsapi.web.nhl.com/api/v1/game/${game.gamePk}/feed/live`;
        return await safeFetch(url);
      }
    }catch(e){ /* fall through */ }

    // api-web fallback
    try{
      const url = `https://api-web.nhle.com/v1/gamecenter/${game.gamePk}/play-by-play`;
      return await safeFetch(url);
    }catch(e){
      return null; // last resort
    }
  }

  function renderHeader(game, live){
    const awayName = game.teams.away.team.name || 'Away';
    const homeName = game.teams.home.team.name || 'Home';

    // scores from whichever feed we have
    let awayScore = game.teams.away.score ?? 0;
    let homeScore = game.teams.home.score ?? 0;

    const ls = live?.liveData?.linescore;
    if (ls?.teams?.away?.goals != null) awayScore = ls.teams.away.goals;
    if (ls?.teams?.home?.goals != null) homeScore = ls.teams.home.goals;

    // api-web scoreboard fallback locations
    if (live?.homeTeam?.score != null) {
      homeScore = live.homeTeam.score; awayScore = live.awayTeam.score;
    }

    document.getElementById('awayTeam').querySelector('.name').textContent = awayName;
    document.getElementById('homeTeam').querySelector('.name').textContent = homeName;
    document.getElementById('score').textContent = `${awayScore} — ${homeScore}`;

    const status = (live?.gameData?.status?.detailedState) ||
                   (game.status?.detailedState) ||
                   (live?.gameState) || '—';
    document.getElementById('state').textContent = status;

    let when = '';
    if (ls?.currentPeriodTimeRemaining) {
      when = `${ls.currentPeriodOrdinal || ''} ${ls.currentPeriodTimeRemaining}`;
    } else if (live?.periodDescriptor?.number && live?.clock?.timeRemaining) {
      when = `P${live.periodDescriptor.number} ${live.clock.timeRemaining}`;
    } else if (game.gameDate) {
      const dt = new Date(game.gameDate);
      when = dt.toLocaleString([], {weekday:'short', hour:'numeric', minute:'2-digit'});
    }
    document.getElementById('when').textContent = when || '—';
  }

  function renderGoals(live){
    const box = document.getElementById('goals');
    // StatsAPI
    if (live?.liveData?.plays?.scoringPlays){
      const plays = live.liveData.plays;
      const idxs = plays.scoringPlays;
      if (!idxs.length){ box.textContent='No goals yet.'; return; }
      box.innerHTML='';
      for (const i of idxs){
        const p = plays.allPlays[i];
        const period = p.about?.ordinalNum || '';
        const time = p.about?.periodTime || '';
        const team = p.team?.name || '';
        const scorer = (p.players||[]).find(x=>x.playerType==='Scorer');
        const assists = (p.players||[]).filter(x=>x.playerType==='Assist');
        const strength = p.result?.strength?.code || '';
        const en = p.result?.emptyNet ? ', EN' : '';
        box.insertAdjacentHTML('beforeend', `
          <div class="goal">
            <div class="time">${period} ${time}</div>
            <div>
              <span class="who">${team}</span>
              <span class="sep">—</span>
              <span class="who">${scorer?.player?.fullName || 'Unknown'}</span>
              <span class="sep">(${strength}${en})</span>
              ${assists.length ? `<div class="assist">Assists: ${assists.map(a=>a.player.fullName).join(', ')}</div>` : ''}
            </div>
          </div>`);
      }
      return;
    }
    // api-web fallback
    if (live?.plays) {
      const scoring = live.plays.filter(p=>p.typeDescKey==='goal');
      if (!scoring.length){ box.textContent='No goals yet.'; return; }
      box.innerHTML='';
      for (const p of scoring){
        const period = `P${p.periodDescriptor?.number||''}`;
        const time = p.timeInPeriod || '';
        const team = p.team?.name?.default || '';
        const scorer = p.details?.scorer?.fullName || 'Unknown';
        const assists = (p.details?.assists||[]).map(a=>a.fullName);
        const strength = (p.details?.strength || '').toUpperCase();
        const en = p.details?.emptyNet ? ', EN' : '';
        box.insertAdjacentHTML('beforeend', `
          <div class="goal">
            <div class="time">${period} ${time}</div>
            <div>
              <span class="who">${team}</span>
              <span class="sep">—</span>
              <span class="who">${scorer}</span>
              <span class="sep">(${strength}${en})</span>
              ${assists.length ? `<div class="assist">Assists: ${assists.join(', ')}</div>` : ''}
            </div>
          </div>`);
      }
      return;
    }
    box.textContent = 'No play-by-play available.';
  }

  // ---- main flow with endpoint fallback ----
  try{
    let game = null, live = null;

    try {
      game = await getGameViaStatsApi();
    } catch (e) {
      // continue to fallback
    }
    if (!game){
      game = await getGameViaApiWeb();    // may still be null
    }
    if (!game){
      document.getElementById('state').textContent='No recent/next Sabres game found.';
      document.getElementById('goals').textContent='—';
      return;
    }

    // live/play-by-play
    try{
      live = await getLiveFeed(game);
    }catch(e){ /* allow to be null */ }

    renderHeader(game, live);
    renderGoals(live);

    // auto-refresh if live and feed is available
    const isLive = (live?.gameData?.status?.abstractGameState||live?.gameState||'')
                    .toString().toLowerCase()==='live';
    if (isLive){
      setInterval(async ()=>{
        const l = await getLiveFeed(game);
        renderHeader(game, l);
        renderGoals(l);
      }, 15000);
    }
  }catch(err){
    document.getElementById('state').textContent = 'Error loading data';
    document.getElementById('goals').textContent = String(err);
  }
})();
</script>
