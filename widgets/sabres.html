<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Sabres Score Widget</title>

<style>
  :root {
    --bg:#0b0f14; --panel:#0f1722; --text:#e5e7eb; --muted:#94a3b8;
    --accent:#60a5fa; --border:#1f2937;
  }
  body {
    margin:0; background:var(--bg); color:var(--text);
    font-family:system-ui, sans-serif; width:480px; height:320px;
    overflow:hidden; display:flex; align-items:center; justify-content:center;
  }
  .box {
    width:460px; height:300px; background:var(--panel);
    border:1px solid var(--border); border-radius:14px; padding:18px;
    display:flex; flex-direction:column; justify-content:space-between;
  }
  h2{margin:0; font-size:1.45rem; color:var(--accent); text-align:center}
  .row{margin-top:6px; font-size:1.2rem; text-align:center}
  .small{font-size:.9rem; color:var(--muted); text-align:center}
  .title{margin-top:16px; font-size:1.05rem; color:var(--accent); text-align:center; font-weight:600}
  .updating{font-size:.75rem; color:var(--muted); text-align:center; margin-top:6px}
</style>
</head>
<body>
<div class="box">
  <h2>Buffalo Sabres</h2>

  <div class="title">Last Game</div>
  <div id="last" class="row">Loading…</div>

  <div class="title">Next Game</div>
  <div id="next" class="row"></div>
  <div id="next_extra" class="small"></div>

  <div class="updating">Auto-refreshing every 60s</div>
</div>

  <script>
async function loadSabresWidget() {
  const lastEl = document.getElementById("last");
  const nextEl = document.getElementById("next");
  const nextExtra = document.getElementById("next_extra");

  // helpers
  const toTime = (ev) => Date.parse(ev?.date || ev?.competitions?.[0]?.date || 0) || 0;
  const compOf  = (e) => e?.competitions?.[0] || null;
  const teamsOf = (c) => Array.isArray(c?.competitors) ? c.competitors : [];
  const isBUF   = (t) => t?.team?.abbreviation === "BUF";
  const bufTeam = (ts) => ts.find(isBUF);
  const oppTeam = (ts) => ts.find((t) => !isBUF(t));
  const scoreOf = (t) => {
    // ESPN can return "3" or { value: 3 }
    const s = t?.score;
    if (s == null) return null;
    if (typeof s === "string" || typeof s === "number") return String(s);
    if (typeof s === "object" && s.value != null) return String(s.value);
    return null;
  };
  const vsAt = (buf) => (buf?.homeAway === "home" ? "vs" : "at");

  try {
    const url = "https://site.api.espn.com/apis/site/v2/sports/hockey/nhl/teams/buf/schedule";
    const data = await fetch(url, { cache: "no-store" }).then((r) => r.json());
    const events = Array.isArray(data.events) ? data.events : [];

    // partition
    const finals = [];
    const upcoming = [];
    for (const ev of events) {
      const c = compOf(ev);
      if (!c) continue;
      const st = c.status?.type || {};
      if (st.completed) finals.push(ev);
      else if ((st.state || "").toLowerCase() === "pre") upcoming.push(ev);
    }
    finals.sort((a, b) => toTime(a) - toTime(b));
    upcoming.sort((a, b) => toTime(a) - toTime(b));

    // last final
    if (finals.length) {
      const game = finals[finals.length - 1];
      const c = compOf(game), ts = teamsOf(c);
      const buf = bufTeam(ts), opp = oppTeam(ts);
      const bufScore = scoreOf(buf) ?? "0";
      const oppScore = scoreOf(opp) ?? "0";
      const oppName  = opp?.team?.shortDisplayName || opp?.team?.name || "—";
      lastEl.textContent = `${bufScore}–${oppScore} ${vsAt(buf)} ${oppName}`;
    } else {
      lastEl.textContent = "No final game found";
    }

    // next scheduled
    if (upcoming.length) {
      const game = upcoming[0];
      const c = compOf(game), ts = teamsOf(c);
      const buf = bufTeam(ts), opp = oppTeam(ts);
      const oppName = opp?.team?.shortDisplayName || opp?.team?.name || "—";
      const when = c?.status?.type?.shortDetail
                || game?.shortName
                || new Date(toTime(game)).toLocaleString(undefined, { month: "2-digit", day: "2-digit", hour: "numeric", minute: "2-digit" });
      nextEl.textContent = `${vsAt(buf)} ${oppName}`;
      nextExtra.textContent = when;
    } else {
      nextEl.textContent = "No upcoming games";
      nextExtra.textContent = "";
    }
  } catch (err) {
    console.error(err);
    lastEl.textContent = "Error loading data";
    nextEl.textContent = "";
    nextExtra.textContent = "";
  }
}

loadSabresWidget();
setInterval(loadSabresWidget, 60000);
</script>


</body>
</html>
