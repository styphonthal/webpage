<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Buffalo Sabres — Scores & Goals</title>
<style>
  :root{
    /* Sabres theme */
    --sabres-navy: #002654;
    --sabres-gold: #FCB514;
    --sabres-white: #f7f9fc;
    --bg-deep: #001631;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    min-height:100vh;
    color:var(--sabres-white);
    background:
      radial-gradient(1200px 700px at 80% 10%, rgba(252,181,20,.12), transparent 60%),
      radial-gradient(900px 500px at 20% 80%, rgba(0,38,84,.35), transparent 70%),
      var(--bg-deep);
    font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
  }
  /* Full-bleed container */
  .wrap{
    max-width:none; width:100%;
    padding:28px clamp(16px, 3vw, 36px);
  }

  /* Score header */
  .scorebar{
    display:flex; align-items:center; justify-content:space-between;
    gap:18px; flex-wrap:wrap;
    background: linear-gradient(180deg, rgba(0,38,84,.85), rgba(0,28,62,.85));
    border: 2px solid rgba(252,181,20,.35);
    border-radius:18px;
    padding:18px 20px;
    box-shadow: 0 12px 30px rgba(0,0,0,.35);
  }
  .teams{
    display:grid; grid-template-columns: 1fr auto 1fr; align-items:center; gap:12px;
    flex:1 1 auto;
  }
  .team{
    display:flex; align-items:center; gap:12px;
    min-width:0;
  }
  .badge{
    width:44px; height:44px; border-radius:10px;
    background: linear-gradient(135deg, var(--sabres-gold), #ffd56a);
    outline: 3px solid rgba(0,38,84,.6);
  }
  .name{font-weight:700; letter-spacing:.2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .score{
    font-weight:800; font-size:2.1rem; padding:0 10px;
  }
  .meta{
    display:flex; flex-direction:column; align-items:flex-end; gap:4px;
    min-width:160px;
    color:#cfe1ff;
  }
  .state{font-weight:700}
  .pill{
    display:inline-block; font-size:.85rem; padding:4px 8px; border-radius:999px;
    background: rgba(252,181,20,.18); border:1px solid rgba(252,181,20,.35); color:#ffe9b3;
  }

  /* Panels */
  .panel{
    margin-top:18px;
    background: linear-gradient(180deg, rgba(0,38,84,.72), rgba(0,28,62,.72));
    border: 1px solid rgba(252,181,20,.28);
    border-radius:16px; padding:14px 16px;
  }
  .panel h3{margin:6px 0 10px 0; font-size:1.05rem; color:#eaf2ff}

  /* Goals list */
  .goals{display:grid; gap:10px}
  .goal{
    display:grid; grid-template-columns: 78px 1fr; gap:12px; align-items:baseline;
    padding:10px; border-radius:12px;
    background: rgba(255,255,255,.03);
    border:1px solid rgba(255,255,255,.06);
  }
  .time{font-weight:700; color:#ffe3a3}
  .who{font-weight:700}
  .assist{color:#c6d6f6}
  .sep{opacity:.35; padding:0 4px}

  @media (max-width:640px){
    .teams{grid-template-columns: 1fr; text-align:center}
    .meta{align-items:center}
  }
</style>
</head>
<body>
  <div class="wrap">
    <!-- Primary bar (today/live/last finished/next) -->
    <div class="scorebar" id="scorebar">
      <div class="teams">
        <div class="team" id="awayTeam">
          <div class="badge" aria-hidden="true"></div>
          <div class="name">Away</div>
        </div>
        <div class="score" id="score">0 — 0</div>
        <div class="team" id="homeTeam">
          <div class="badge" aria-hidden="true" style="background:linear-gradient(135deg,#ffd56a,var(--sabres-gold))"></div>
          <div class="name">Home</div>
        </div>
      </div>
      <div class="meta">
        <div class="state" id="state">Loading…</div>
        <div><span class="pill" id="when"></span></div>
      </div>
    </div>

    <!-- Last/Next summaries -->
    <div class="panel" id="lastGamePanel">
      <h3>Last Game</h3>
      <div id="lastGameBox">Loading…</div>
    </div>

    <div class="panel" id="nextGamePanel">
      <h3>Next Game</h3>
      <div id="nextGameBox">Loading…</div>
    </div>

    <!-- Goals -->
    <div class="panel">
      <h3>Goals</h3>
      <div class="goals" id="goals">Fetching…</div>
    </div>
  </div>

<script>
(async function(){
  const SABRES_ID = 7;
  const TZ = 'America/New_York';

  // ---------- helpers ----------
  const sleep = ms => new Promise(r => setTimeout(r, ms));

  function nyDate(d = new Date()){
    const y = d.toLocaleString('en-CA', {timeZone: TZ, year:'numeric'});
    const m = d.toLocaleString('en-CA', {timeZone: TZ, month:'2-digit'});
    const day = d.toLocaleString('en-CA', {timeZone: TZ, day:'2-digit'});
    return `${y}-${m}-${day}`;
  }

  function toLocalDate(dstr){
    try { return new Date(dstr); } catch { return null; }
  }

  async function safeFetch(url, opt={}, retries=2, backoff=400){
    for (let i=0;i<=retries;i++){
      try{
        const r = await fetch(url, {cache:'no-store', ...opt});
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        return await r.json();
      }catch(e){
        if (i===retries) throw e;
        await sleep(backoff*(i+1));
      }
    }
  }

  // ---------- primary: statsapi ----------
  async function getScheduleStatsApi(){
    const now = new Date();
    const start = new Date(now); start.setDate(start.getDate()-30);
    const end   = new Date(now); end.setDate(end.getDate()+30);

    const url = `https://statsapi.web.nhl.com/api/v1/schedule` +
      `?teamId=${SABRES_ID}` +
      `&expand=schedule.teams,schedule.linescore` +
      `&startDate=${nyDate(start)}&endDate=${nyDate(end)}`;

    const data = await safeFetch(url);
    const games = (data.dates||[]).flatMap(d => d.games || []);
    return games;
  }

  // ---------- fallback: api-web ----------
  async function getScheduleApiWeb(){
    const now = new Date();
    const days = [];
    for (let i=-14;i<=14;i++){
      const d = new Date(now); d.setDate(d.getDate()+i);
      days.push(nyDate(d));
    }
    const results = [];
    for (const day of days){
      try{
        const data = await safeFetch(`https://api-web.nhle.com/v1/score/${day}`);
        for (const g of (data.games||[])){
          if (g.awayTeam?.id===SABRES_ID || g.homeTeam?.id===SABRES_ID){
            results.push({
              gamePk: g.id,
              gameDate: g.startTimeUTC,
              status: { detailedState: g.gameState, abstractGameState: stateToAbstract(g.gameState) },
              teams: {
                away: { team: { name: (g.awayTeam?.placeName?.default||'') + ' ' + (g.awayTeam?.commonName?.default||'') }, score: g.awayTeam?.score ?? 0, id: g.awayTeam?.id },
                home: { team: { name: (g.homeTeam?.placeName?.default||'') + ' ' + (g.homeTeam?.commonName?.default||'') }, score: g.homeTeam?.score ?? 0, id: g.homeTeam?.id },
              },
              __apiweb: true
            });
          }
        }
      }catch(_){ /* ignore day failure */ }
    }
    results.sort((a,b)=> new Date(a.gameDate) - new Date(b.gameDate));
    return results;
  }

  function stateToAbstract(s=''){
    s = s.toLowerCase();
    if (s==='live') return 'Live';
    if (s==='final' || s==='completed') return 'Final';
    return 'Preview';
  }

  async function getLiveFeed(game){
    if (!game.__apiweb){
      try{
        return await safeFetch(`https://statsapi.web.nhl.com/api/v1/game/${game.gamePk}/feed/live`);
      }catch(_){ /* fall through */ }
    }
    try{
      return await safeFetch(`https://api-web.nhle.com/v1/gamecenter/${game.gamePk}/play-by-play`);
    }catch(_){
      return null;
    }
  }

  // ---------- pickers ----------
  function pickGames(games){
    const now = new Date();
    const live = games.find(g => (g.status?.abstractGameState||'').toLowerCase()==='live');

    const past = games.filter(g => new Date(g.gameDate) <= now);
    const future = games.filter(g => new Date(g.gameDate) > now);

    const finished = past.filter(g => (g.status?.detailedState||'').toLowerCase().includes('final'));
    const lastFinished = finished.length ? finished[finished.length-1] : (past.length ? past[past.length-1] : null);

    const nextScheduled = future.length ? future[0] : null;

    const todayStr = nyDate(now);
    const today = games.find(g => (g.gameDate||'').slice(0,10) === todayStr) || null;

    return { live, lastFinished, nextScheduled, today };
  }

  // ---------- render ----------
  function fmtTeamName(t){
    return t?.team?.name || '—';
  }

  function renderScorebar(game, live){
    const awayName = fmtTeamName(game.teams.away);
    const homeName = fmtTeamName(game.teams.home);

    let awayScore = game.teams.away.score ?? 0;
    let homeScore = game.teams.home.score ?? 0;

    const ls = live?.liveData?.linescore;
    if (ls?.teams?.away?.goals != null) awayScore = ls.teams.away.goals;
    if (ls?.teams?.home?.goals != null) homeScore = ls.teams.home.goals;

    if (live?.homeTeam?.score != null) {
      homeScore = live.homeTeam.score; awayScore = live.awayTeam.score;
    }

    document.getElementById('awayTeam').querySelector('.name').textContent = awayName;
    document.getElementById('homeTeam').querySelector('.name').textContent = homeName;
    document.getElementById('score').textContent = `${awayScore} — ${homeScore}`;

    const status = (live?.gameData?.status?.detailedState) ||
                   (game.status?.detailedState) ||
                   (live?.gameState) || '—';
    document.getElementById('state').textContent = status;

    let when = '';
    if (ls?.currentPeriodTimeRemaining) {
      when = `${ls.currentPeriodOrdinal || ''} ${ls.currentPeriodTimeRemaining}`;
    } else if (live?.periodDescriptor?.number && live?.clock?.timeRemaining) {
      when = `P${live.periodDescriptor.number} ${live.clock.timeRemaining}`;
    } else if (game.gameDate) {
      const dt = toLocalDate(game.gameDate);
      when = dt ? dt.toLocaleString([], {weekday:'short', hour:'numeric', minute:'2-digit'}) : '';
    }
    document.getElementById('when').textContent = when || '—';
  }

  function renderGoals(live, targetId='goals'){
    const box = document.getElementById(targetId);
    if (!box) return;

    const plays = live?.liveData?.plays;
    if (plays?.scoringPlays){
      const idxs = plays.scoringPlays;
      if (!idxs.length){ box.textContent='No goals yet.'; return; }
      box.innerHTML='';
      for (const i of idxs){
        const p = plays.allPlays[i];
        const period = p.about?.ordinalNum || '';
        const time = p.about?.periodTime || '';
        const team = p.team?.name || '';
        const scorer = (p.players||[]).find(x=>x.playerType==='Scorer');
        const assists = (p.players||[]).filter(x=>x.playerType==='Assist');
        const strength = p.result?.strength?.code || '';
        const en = p.result?.emptyNet ? ', EN' : '';
        box.insertAdjacentHTML('beforeend', `
          <div class="goal">
            <div class="time">${period} ${time}</div>
            <div>
              <span class="who">${team}</span>
              <span class="sep">—</span>
              <span class="who">${scorer?.player?.fullName || 'Unknown'}</span>
              <span class="sep">(${strength}${en})</span>
              ${assists.length ? `<div class="assist">Assists: ${assists.map(a=>a.player.fullName).join(', ')}</div>` : ''}
            </div>
          </div>`);
      }
      return;
    }
    if (live?.plays) {
      const scoring = live.plays.filter(p=>p.typeDescKey==='goal');
      if (!scoring.length){ box.textContent='No goals yet.'; return; }
      box.innerHTML='';
      for (const p of scoring){
        const period = `P${p.periodDescriptor?.number||''}`;
        const time = p.timeInPeriod || '';
        const team = p.team?.name?.default || '';
        const scorer = p.details?.scorer?.fullName || 'Unknown';
        const assists = (p.details?.assists||[]).map(a=>a.fullName);
        const strength = (p.details?.strength || '').toUpperCase();
        const en = p.details?.emptyNet ? ', EN' : '';
        box.insertAdjacentHTML('beforeend', `
          <div class="goal">
            <div class="time">${period} ${time}</div>
            <div>
              <span class="who">${team}</span>
              <span class="sep">—</span>
              <span class="who">${scorer}</span>
              <span class="sep">(${strength}${en})</span>
              ${assists.length ? `<div class="assist">Assists: ${assists.join(', ')}</div>` : ''}
            </div>
          </div>`);
      }
      return;
    }
    box.textContent = 'No play-by-play available.';
  }

  function renderLastGameSummary(game){
    const box = document.getElementById('lastGameBox');
    if (!game){ box.textContent = '—'; return; }
    const dt = toLocalDate(game.gameDate);
    const when = dt ? dt.toLocaleString([], {weekday:'short', month:'short', day:'numeric', hour:'numeric', minute:'2-digit'}) : '';
    const away = fmtTeamName(game.teams.away);
    const home = fmtTeamName(game.teams.home);
    const a = game.teams.away.score ?? '—';
    const h = game.teams.home.score ?? '—';
    box.innerHTML = `
      <div><strong>${away}</strong> at <strong>${home}</strong></div>
      <div>Final: ${a} — ${h}</div>
      <div>${when}</div>
    `;
  }

  function renderNextGameSummary(game){
    const box = document.getElementById('nextGameBox');
    if (!game){ box.textContent = '—'; return; }
    const dt = toLocalDate(game.gameDate);
    const when = dt ? dt.toLocaleString([], {weekday:'short', month:'short', day:'numeric', hour:'numeric', minute:'2-digit'}) : '';
    const away = fmtTeamName(game.teams.away);
    const home = fmtTeamName(game.teams.home);
    box.innerHTML = `
      <div><strong>${away}</strong> at <strong>${home}</strong></div>
      <div>${when}</div>
    `;
  }

  // ---------- main ----------
  try{
    let games = [];
    try {
      games = await getScheduleStatsApi();
    } catch(_){
      games = await getScheduleApiWeb();
    }
    if (!games.length) throw new Error('No games found');

    games.sort((a,b)=> new Date(a.gameDate) - new Date(b.gameDate));

    const { live, lastFinished, nextScheduled, today } = pickGames(games);

    const primary = live || today || lastFinished || nextScheduled;

    let feed = null;
    if (primary){
      try { feed = await getLiveFeed(primary); } catch(_){ /* non-fatal */ }
    }

    renderScorebar(primary || games[games.length-1], feed);
    renderGoals(feed, 'goals');
    renderLastGameSummary(lastFinished);
    renderNextGameSummary(nextScheduled);

    const isLive =
      (feed?.gameData?.status?.abstractGameState || feed?.gameState || '')
      .toString().toLowerCase() === 'live';

    if (isLive && primary){
      const liveUrlStats = `https://statsapi.web.nhl.com/api/v1/game/${primary.gamePk}/feed/live`;
      const liveUrlWeb   = `https://api-web.nhle.com/v1/gamecenter/${primary.gamePk}/play-by-play`;
      setInterval(async ()=>{
        try {
          feed = primary.__apiweb
            ? await safeFetch(liveUrlWeb, {}, 1)
            : await safeFetch(liveUrlStats, {}, 1);
          renderScorebar(primary, feed);
          renderGoals(feed, 'goals');
        }catch(_){ /* keep previous */ }
      }, 15000);
    }
  }catch(err){
    document.getElementById('state').textContent = 'Error loading data';
    document.getElementById('goals').textContent = String(err);
    const lg = document.getElementById('lastGameBox'); if (lg) lg.textContent = '—';
    const ng = document.getElementById('nextGameBox'); if (ng) ng.textContent = '—';
  }
})();
</script>
</body>
</html>
