<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Buffalo Sabres — Live</title>
<style>
  :root{
    /* Buffalo Sabres theme */
    --sabres-navy: #002654;
    --sabres-gold: #FCB514;
    --sabres-white: #f7f9fc;
    --bg-deep: #001631;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    min-height:100vh;
    color:var(--sabres-white);
    background:
      radial-gradient(1200px 700px at 80% 10%, rgba(252,181,20,.12), transparent 60%),
      radial-gradient(900px 500px at 20% 80%, rgba(0,38,84,.35), transparent 70%),
      var(--bg-deep);
    font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
  }
  /* Full-bleed container */
  .wrap{
    max-width:none; width:100%;
    padding:28px clamp(16px, 3vw, 36px);
  }

  /* Score header */
  .scorebar{
    display:flex; align-items:center; justify-content:space-between;
    gap:18px; flex-wrap:wrap;
    background: linear-gradient(180deg, rgba(0,38,84,.85), rgba(0,28,62,.85));
    border: 2px solid rgba(252,181,20,.35);
    border-radius:18px;
    padding:18px 20px;
    box-shadow: 0 12px 30px rgba(0,0,0,.35);
  }
  .teams{
    display:grid; grid-template-columns: 1fr auto 1fr; align-items:center; gap:12px;
    flex:1 1 auto;
  }
  .team{
    display:flex; align-items:center; gap:12px;
    min-width:0;
  }
  .badge{
    width:44px; height:44px; border-radius:10px;
    background: linear-gradient(135deg, var(--sabres-gold), #ffd56a);
    outline: 3px solid rgba(0,38,84,.6);
  }
  .name{font-weight:700; letter-spacing:.2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .score{
    font-weight:800; font-size:2.1rem; padding:0 10px;
  }
  .meta{
    display:flex; flex-direction:column; align-items:flex-end; gap:4px;
    min-width:160px;
    color:#cfe1ff;
  }
  .state{font-weight:700}
  .pill{
    display:inline-block; font-size:.85rem; padding:4px 8px; border-radius:999px;
    background: rgba(252,181,20,.18); border:1px solid rgba(252,181,20,.35); color:#ffe9b3;
  }

  /* Goal list */
  .panel{
    margin-top:18px;
    background: linear-gradient(180deg, rgba(0,38,84,.72), rgba(0,28,62,.72));
    border: 1px solid rgba(252,181,20,.28);
    border-radius:16px; padding:14px 16px;
  }

  .panel h3{margin:6px 0 10px 0; font-size:1.05rem; color:#eaf2ff}
  .goals{display:grid; gap:10px}
  .goal{
    display:grid; grid-template-columns: 78px 1fr; gap:12px; align-items:baseline;
    padding:10px; border-radius:12px;
    background: rgba(255,255,255,.03);
    border:1px solid rgba(255,255,255,.06);
  }
  .time{font-weight:700; color:#ffe3a3}
  .who{font-weight:700}
  .assist{color:#c6d6f6}
  .sep{opacity:.35; padding:0 4px}

  @media (max-width:640px){
    .teams{grid-template-columns: 1fr; text-align:center}
    .meta{align-items:center}
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="scorebar" id="scorebar">
      <div class="teams">
        <div class="team" id="awayTeam">
          <div class="badge" aria-hidden="true"></div>
          <div class="name">Away</div>
        </div>
        <div class="score" id="score">0 — 0</div>
        <div class="team" id="homeTeam">
          <div class="badge" aria-hidden="true" style="background:linear-gradient(135deg,#ffd56a,var(--sabres-gold))"></div>
          <div class="name">Home</div>
        </div>
      </div>
      <div class="meta">
        <div class="state" id="state">Loading…</div>
        <div><span class="pill" id="when"></span></div>
      </div>
    </div>

    <div class="panel">
      <h3>Goals</h3>
      <div class="goals" id="goals">Fetching…</div>
    </div>
  </div>

<script>
(async function(){
  const SABRES_ID = 7;

  // 1) Find the most recent or current Sabres game
  async function getLatestGame() {
    const url = `https://statsapi.web.nhl.com/api/v1/schedule?teamId=${SABRES_ID}&expand=schedule.teams,schedule.linescore&date=${new Date().toISOString().slice(0,10)}`;
    const res = await fetch(url);
    const data = await res.json();

    // If no game today, ask for the last 7 days and pick last game
    if (!data.dates?.length) {
      const now = new Date(); const past = new Date(now); past.setDate(now.getDate()-7);
      const u = `https://statsapi.web.nhl.com/api/v1/schedule?teamId=${SABRES_ID}&expand=schedule.teams,schedule.linescore&startDate=${past.toISOString().slice(0,10)}&endDate=${now.toISOString().slice(0,10)}`;
      const r = await fetch(u); const d = await r.json();
      const games = (d.dates||[]).flatMap(x=>x.games||[]);
      return games.at(-1) || null;
    }
    return data.dates[0].games[0];
  }

  // 2) Render header
  function renderHeader(game, live) {
    const awayName = game.teams.away.team.name;
    const homeName = game.teams.home.team.name;
    const awayScore = live?.liveData?.linescore?.teams?.away?.goals ?? game.teams.away.score;
    const homeScore = live?.liveData?.linescore?.teams?.home?.goals ?? game.teams.home.score;

    document.getElementById('awayTeam').querySelector('.name').textContent = awayName;
    document.getElementById('homeTeam').querySelector('.name').textContent = homeName;
    document.getElementById('score').textContent = `${awayScore} — ${homeScore}`;

    const status = live?.gameData?.status?.detailedState || game.status.detailedState;
    document.getElementById('state').textContent = status;

    const ls = live?.liveData?.linescore;
    let when = '';
    if (ls?.currentPeriodTimeRemaining) {
      when = `${ls.currentPeriodOrdinal || ''} ${ls.currentPeriodTimeRemaining}`;
    } else if (game.gameDate) {
      const dt = new Date(game.gameDate);
      when = dt.toLocaleString([], {weekday:'short', hour:'numeric', minute:'2-digit'});
    }
    document.getElementById('when').textContent = when || '—';
  }

  // 3) Extract and render goals (scorers + assists)
  function renderGoals(live){
    const goalsBox = document.getElementById('goals');
    const plays = live?.liveData?.plays;
    if (!plays) { goalsBox.textContent = 'No data.'; return; }

    const scoringPlays = plays.scoringPlays || [];
    if (!scoringPlays.length){
      goalsBox.textContent = 'No goals yet.';
      return;
    }

    goalsBox.innerHTML = '';
    for (const idx of scoringPlays){
      const p = plays.allPlays[idx];
      const period = p.about?.ordinalNum || '';
      const time = p.about?.periodTime || '';
      const result = p.result || {};
      const team = p.team?.name || '';
      const players = p.players || [];

      const scorer = players.find(x=>x.playerType === 'Scorer');
      const assists = players.filter(x=>x.playerType === 'Assist');

      const el = document.createElement('div');
      el.className = 'goal';
      el.innerHTML = `
        <div class="time">${period} ${time}</div>
        <div>
          <span class="who">${team}</span>
          <span class="sep">—</span>
          <span class="who">${scorer?.player?.fullName || 'Unknown'}</span>
          <span class="sep">(${result.strength?.code || ''}${result.emptyNet ? ', EN' : ''})</span>
          ${assists.length ? `<div class="assist">Assists: ${assists.map(a=>a.player.fullName).join(', ')}</div>` : ''}
        </div>`;
      goalsBox.appendChild(el);
    }
  }

  try{
    const game = await getLatestGame();
    if (!game){ document.getElementById('state').textContent='No recent game found.'; return; }

    const liveUrl = `https://statsapi.web.nhl.com/api/v1/game/${game.gamePk}/feed/live`;
    const live = await (await fetch(liveUrl)).json();

    renderHeader(game, live);
    renderGoals(live);

    // Auto-refresh during live games
    if ((live?.gameData?.status?.abstractGameState || '').toLowerCase() === 'live'){
      setInterval(async ()=>{
        const l = await (await fetch(liveUrl, {cache:'no-store'})).json();
        renderHeader(game, l);
        renderGoals(l);
      }, 15000);
    }
  }catch(err){
    document.getElementById('state').textContent = 'Error loading data';
    document.getElementById('goals').textContent = String(err);
  }
})();
</script>
</body>
</html>
