<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Sabres Score Widget</title>
<meta name="viewport" content="width=480, initial-scale=1">
<style>
  :root {
    --bg:#0b0f14;
    --panel:#0f1722;
    --text:#e5e7eb;
    --muted:#94a3b8;
    --accent:#60a5fa;
    --border:#1f2937;
  }
  body {
    margin:0;
    background:var(--bg);
    color:var(--text);
    font-family:system-ui, sans-serif;
    width:480px;
    height:320px;
    overflow:hidden;
    display:flex;
    align-items:center;
    justify-content:center;
  }

  .box {
    width:460px;
    height:300px;
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:14px;
    padding:18px;
    display:flex;
    flex-direction:column;
    justify-content:space-between;
  }

  h2 {
    margin:0;
    font-size:1.45rem;
    color:var(--accent);
    text-align:center;
  }

  .row {
    margin-top:6px;
    font-size:1.2rem;
    text-align:center;
  }

  .small {
    font-size:0.9rem;
    color:var(--muted);
    text-align:center;
  }

  .title {
    margin-top:16px;
    font-size:1.05rem;
    color:var(--accent);
    text-align:center;
    font-weight:600;
  }

  .updating {
    font-size:0.75rem;
    color:var(--muted);
    text-align:center;
    margin-top:6px;
  }
</style>
</head>
<body>

<div class="box">
  <h2>Buffalo Sabres</h2>

  <div class="title">Last Game</div>
  <div id="last" class="row">Loading…</div>

  <div class="title">Next Game</div>
  <div id="next" class="row"></div>
  <div id="next_extra" class="small"></div>

  <div class="updating">Auto-refreshing every 60s</div>
</div>

<script>
async function loadSabresWidget() {
  const lastEl = document.getElementById("last");
  const nextEl = document.getElementById("next");
  const nextExtra = document.getElementById("next_extra");

  try {
    const url = "https://site.api.espn.com/apis/site/v2/sports/hockey/nhl/scoreboard";
    const data = await fetch(url, {cache:"no-store"}).then(r => r.json());

    const events = data.events || [];

    const sabresGames = events.filter(ev =>
      ev.competitions?.[0]?.competitors?.some(c => c.team?.shortDisplayName === "BUF")
    );

    // -------------------
    // FIND LAST FINISHED GAME
    // -------------------
    const finals = sabresGames.filter(ev =>
      ev.competitions[0].status.type.name === "STATUS_FINAL"
    );

    if (finals.length > 0) {
      // Most recent final = last final in list
      const game = finals[finals.length - 1];
      const comp = game.competitions[0];
      const teams = comp.competitors;

      const buf = teams.find(t => t.team.shortDisplayName === "BUF");
      const opp = teams.find(t => t.team.shortDisplayName !== "BUF");

      const score = `${buf.score}–${opp.score}`;
      lastEl.textContent = `${score} vs ${opp.team.shortDisplayName}`;
    } else {
      lastEl.textContent = "No final game found";
    }

    // -------------------
    // FIND NEXT SCHEDULED GAME
    // -------------------
    const scheduled = sabresGames.filter(ev =>
      ev.competitions[0].status.type.name === "STATUS_SCHEDULED"
    );

    if (scheduled.length > 0) {
      // First upcoming game = first scheduled
      const game = scheduled[0];
      const comp = game.competitions[0];
      const teams = comp.competitors;

      const buf = teams.find(t => t.team.shortDisplayName === "BUF");
      const opp = teams.find(t => t.team.shortDisplayName !== "BUF");

      const when = comp.status.type.shortDetail || "Scheduled";

      nextEl.textContent = `vs ${opp.team.shortDisplayName}`;
      nextExtra.textContent = when;
    } else {
      nextEl.textContent = "No upcoming games";
      nextExtra.textContent = "";
    }

  } catch (err) {
    console.error(err);
    lastEl.textContent = "Error loading data";
    nextEl.textContent = "";
  }
}

loadSabresWidget();
setInterval(loadSabresWidget, 60000);
</script>

</body>
</html>
