<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Buffalo Sabres — Scores & Goals</title>
<style>
  :root{
    --sabres-navy: #002654;
    --sabres-gold: #FCB514;
    --sabres-white: #f7f9fc;
    --bg-deep: #001631;
  }
  *{box-sizing:border-box; margin:0; padding:0}
  html,body{height:100%; min-height:100vh}
  body{
    color:var(--sabres-white);
    background:
      radial-gradient(1200px 700px at 80% 10%, rgba(252,181,20,.12), transparent 60%),
      radial-gradient(900px 500px at 20% 80%, rgba(0,38,84,.35), transparent 70%),
      var(--bg-deep);
    font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
    padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
  }

  .wrap{
    max-width:1200px;
    width:100%;
    margin:0 auto;
    padding:28px clamp(16px, 3vw, 36px);
  }

  /* Team Header */
  .team-header{
    position:relative;
    text-align:center;
    margin-bottom:24px;
    padding:24px 20px;
    background: linear-gradient(180deg, rgba(0,38,84,.65), rgba(0,28,62,.65));
    border: 2px solid rgba(252,181,20,.25);
    border-radius:18px;
    box-shadow: 0 8px 24px rgba(0,0,0,.3);
    overflow:hidden;
  }

  .slug{
    position:absolute;
    top:50%;
    transform:translateY(-50%);
    height:200px;
    width:auto;
    opacity:.92;
    pointer-events:none;
    filter:
      drop-shadow(0 12px 20px rgba(0,0,0,.45))
      drop-shadow(0 0 10px rgba(252,181,20,.18))
      drop-shadow(0 0 2px rgba(255,255,255,.12));
  }
  .slug-left{ left:18px; }
  .slug-right{ right:18px; transform:translateY(-50%) scaleX(-1); }

  .team-header-inner{
    position:relative;
    z-index:1;
    max-width:820px;
    margin:0 auto;
    padding:0 240px;
  }

  .header-logo{
    display:block;
    margin:0 auto 12px;
    max-width:min(520px, 86vw);
    height:auto;
    filter: drop-shadow(0 8px 16px rgba(0,0,0,.35));
  }

  .team-stats{
    display:flex;
    justify-content:center;
    gap:32px;
    flex-wrap:wrap;
    margin-top:6px;
  }

  .stat-item{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:4px;
  }

  .stat-label{
    font-size:.9rem;
    color:#a8c5f5;
    font-weight:600;
    text-transform:uppercase;
    letter-spacing:.5px;
  }

  .stat-value{
    font-size:1.25rem;
    color:var(--sabres-gold);
    font-weight:800;
  }

  .top-scorer{
    margin-top:12px;
    padding-top:12px;
    border-top:1px solid rgba(252,181,20,.2);
    color:#cfe1ff;
    font-size:1.05rem;
  }

  .top-scorer strong{
    color:var(--sabres-gold);
    font-weight:800;
  }

  /* Recent form and streak */
  .form-streak{
    display:flex;
    justify-content:center;
    gap:20px;
    margin-top:12px;
    padding-top:12px;
    border-top:1px solid rgba(252,181,20,.2);
    flex-wrap:wrap;
  }

  .form-row{
    display:flex;
    align-items:center;
    gap:6px;
  }

  .form-label{
    font-size:.9rem;
    color:#a8c5f5;
    margin-right:4px;
  }

  .form-dot{
    width:20px;
    height:20px;
    border-radius:50%;
    font-size:.7rem;
    font-weight:900;
    display:flex;
    align-items:center;
    justify-content:center;
    border:2px solid;
  }

  .form-dot.win{
    background:rgba(34,197,94,.25);
    border-color:#22c55e;
    color:#22c55e;
  }

  .form-dot.loss{
    background:rgba(239,68,68,.25);
    border-color:#ef4444;
    color:#ef4444;
  }

  .form-dot.ot{
    background:rgba(251,191,36,.25);
    border-color:#fbbf24;
    color:#fbbf24;
  }

  .streak-text{
    color:#ffe9b3;
    font-weight:700;
  }

  /* Score header */
  .scorebar{
    display:flex;
    flex-direction:column;
    gap:14px;
    background: linear-gradient(180deg, rgba(0,38,84,.85), rgba(0,28,62,.85));
    border: 2px solid rgba(252,181,20,.35);
    border-radius:18px;
    padding:18px 20px;
    box-shadow: 0 12px 30px rgba(0,0,0,.35);
  }

  /* Penalty box */
  .penalty-box{
    background:rgba(239,68,68,.15);
    border:1px solid rgba(239,68,68,.4);
    border-radius:10px;
    padding:10px 14px;
    margin-bottom:8px;
    display:none;
  }

  .penalty-box.active{
    display:block;
  }

  .penalty-info{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:12px;
    flex-wrap:wrap;
    font-size:.95rem;
  }

  .penalty-info strong{
    color:#fca5a5;
  }

  .pp-timer{
    color:#fef3c7;
    font-weight:900;
  }

  .score-top{
    display:grid;
    grid-template-columns: 1fr auto 1fr;
    align-items:center;
    gap:16px;
    min-width:0;
  }

  .team{
    display:flex;
    flex-direction:column;
    gap:8px;
    min-width:0;
  }

  .team.away{ align-items:flex-end; text-align:right; }
  .team.home{ align-items:flex-start; text-align:left; }

  .team-name-row{
    display:flex;
    align-items:center;
    gap:12px;
    min-width:0;
  }
  .team.away .team-name-row{ justify-content:flex-end; }
  .team.home .team-name-row{ justify-content:flex-start; }

  .badge{
    width:64px;
    height:64px;
    border-radius:12px;
    background-size:contain;
    background-position:center;
    background-repeat:no-repeat;
    border:2px solid rgba(252,181,20,.3);
    flex-shrink:0;
  }

  .name{
    font-weight:900;
    letter-spacing:.3px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    font-size:1.18rem;
  }

  .team-metrics{
    display:grid;
    gap:4px;
    color:#cfe1ff;
    font-size:.95rem;
    opacity:.95;
  }
  .metric b{ color:#ffe9b3; font-weight:900; }
  .metric span{ color:#cfe1ff; }

  .center-stack{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:6px;
    min-width:210px;
  }

  .score{
    font-weight:900;
    font-size:2.6rem;
    white-space:nowrap;
    line-height:1.05;
    display:flex;
    align-items:center;
    gap:12px;
  }

  .score-num{
    transition:color .3s;
  }

  .score-num.winning{
    color:var(--sabres-gold);
    text-shadow:0 0 20px rgba(252,181,20,.5);
  }

  .score-num.losing{
    color:#94a3b8;
  }

  .score-sep{
    color:#94a3b8;
  }

  /* Shot clock visualization */
  .shot-clock{
    width:100%;
    max-width:400px;
    margin:12px auto 0;
  }

  .shot-clock-label{
    display:flex;
    justify-content:space-between;
    font-size:.85rem;
    color:#a8c5f5;
    margin-bottom:6px;
  }

  .shot-bar-container{
    width:100%;
    height:8px;
    background:rgba(255,255,255,.1);
    border-radius:4px;
    overflow:hidden;
    display:flex;
  }

  .shot-bar-away{
    background:linear-gradient(90deg, #3b82f6, #60a5fa);
    height:100%;
    transition:width .5s ease;
  }

  .shot-bar-home{
    background:linear-gradient(90deg, #fbbf24, var(--sabres-gold));
    height:100%;
    transition:width .5s ease;
  }

  .mid-meta{
    text-align:center;
    color:#cfe1ff;
    display:flex;
    flex-direction:column;
    gap:4px;
  }
  .state{
    font-weight:900;
    font-size:1.05rem;
  }
  .pill{
    display:inline-block;
    font-size:.9rem;
    padding:5px 12px;
    border-radius:999px;
    background: rgba(252,181,20,.18);
    border:1px solid rgba(252,181,20,.35);
    color:#ffe9b3;
    font-weight:900;
  }
  .muted{
    font-size:.85rem;
    opacity:.75;
  }

  /* Panels */
  .panel{
    margin-top:20px;
    background: linear-gradient(180deg, rgba(0,38,84,.72), rgba(0,28,62,.72));
    border: 1px solid rgba(252,181,20,.28);
    border-radius:16px;
    padding:18px 20px;
  }

  .panel h3{
    margin:0 0 14px 0;
    font-size:1.15rem;
    color:#ffe9b3;
    border-bottom:1px solid rgba(252,181,20,.2);
    padding-bottom:8px;
  }

  .game-summary{
    display:flex;
    flex-direction:column;
    gap:8px;
    font-size:1rem;
  }

  .game-summary strong{
    color:var(--sabres-gold);
    font-weight:900;
  }

  /* Goals list */
  .goals{
    display:grid;
    gap:12px;
    margin-top:14px;
  }

  .goal{
    display:grid;
    grid-template-columns: 110px 1fr;
    gap:14px;
    align-items:start;
    padding:12px 14px;
    border-radius:12px;
    background: rgba(255,255,255,.04);
    border:1px solid rgba(252,181,20,.15);
    transition:all .2s;
  }

  .goal:hover{
    background: rgba(252,181,20,.08);
    border-color:rgba(252,181,20,.3);
  }

  .time{
    font-weight:900;
    color:#ffe3a3;
    font-size:.95rem;
  }

  .goal-details{
    display:flex;
    flex-direction:column;
    gap:4px;
  }

  .who{
    font-weight:900;
    color:var(--sabres-white);
  }

  .team-name{
    color:var(--sabres-gold);
    font-weight:900;
  }

  .assist{
    color:#c6d6f6;
    font-size:.92rem;
    margin-top:2px;
  }

  .assist-player{
    display:inline-block;
    margin-right:8px;
  }

  .sep{
    opacity:.4;
    padding:0 6px;
  }

  .strength{
    color:#a8c5f5;
    font-size:.85rem;
    font-weight:900;
  }

  .loading, .error, .info{
    text-align:center;
    padding:20px;
    color:#c6d6f6;
  }

  .error{
    color:#ff9999;
  }

  .info{
    color:#a8c5f5;
    font-size:.95rem;
    line-height:1.6;
  }

  /* Mobile safeguards */
  @media (max-width: 980px){
    .team-header-inner{ padding:0 200px; }
    .slug{ height:170px; }
  }
  @media (max-width:768px){
    .team-header-inner{ padding:0 96px; }
    .slug{ height:120px; opacity:.65; }
    .slug-left{ left:10px; }
    .slug-right{ right:10px; }

    .score-top{
      grid-template-columns: 1fr;
      gap:14px;
    }

    .team.away, .team.home{
      align-items:center;
      text-align:center;
    }
    .team.away .team-name-row,
    .team.home .team-name-row{
      justify-content:center;
    }

    .center-stack{
      min-width:auto;
    }

    .score{ font-size:2.2rem; }

    .goal{
      grid-template-columns: 96px 1fr;
      gap:10px;
    }
  }

  @media (max-width:480px){
    .team-header-inner{ padding:0 18px; }
    .slug{ display:none; }

    .badge{ width:56px; height:56px; }
    .name{ font-size:1.05rem; }
    .score{ font-size:2rem; }

    .header-logo{ max-width:92vw; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <!-- Team Header -->
    <div class="team-header">
      <img class="slug slug-left" src="slug.png" alt="" aria-hidden="true">
      <img class="slug slug-right" src="slug.png" alt="" aria-hidden="true">

      <div class="team-header-inner">
        <img class="header-logo" src="sabres2.png?v=123" alt="Buffalo Sabres">

        <div class="team-stats">
          <div class="stat-item">
            <span class="stat-label">Record</span>
            <span class="stat-value" id="record">—</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Points</span>
            <span class="stat-value" id="points">—</span>
          </div>
        </div>

        <div class="top-scorer" id="standingLine">Loading standings…</div>
        <div class="top-scorer" id="topGoals">Loading leading goals...</div>
        <div class="top-scorer" id="topPoints" style="margin-top:8px; border-top:none; padding-top:0;">
          Loading leading points...
        </div>

        <!-- Recent form and streak -->
        <div class="form-streak">
          <div class="form-row">
            <span class="form-label">Last 5:</span>
            <div id="recentForm"></div>
          </div>
          <div class="form-row">
            <span class="streak-text" id="streakText">—</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Primary score bar -->
    <div class="scorebar" id="scorebar">
      <!-- Penalty indicator -->
      <div class="penalty-box" id="penaltyBox">
        <div class="penalty-info">
          <span><strong id="penaltyTeam">Team</strong> on power play</span>
          <span class="pp-timer" id="penaltyTimer">2:00</span>
        </div>
      </div>

      <div class="score-top">
        <!-- Away -->
        <div class="team away" id="awayTeam">
          <div class="team-name-row">
            <div class="name">Away</div>
            <div class="badge" id="awayBadge"></div>
          </div>

          <div class="team-metrics" id="awayMetrics">
            <div class="metric"><b>SOG</b>: <span id="awaySog">—</span></div>
            <div class="metric"><b>Hits</b>: <span id="awayHits">—</span></div>
            <div class="metric"><b>Blk</b>: <span id="awayBlocks">—</span></div>
            <div class="metric"><b>G</b>: <span id="awayGoalie">—</span></div>
          </div>
        </div>

        <!-- Center -->
        <div class="center-stack">
          <div class="score" id="scoreDisplay">
            <span class="score-num" id="awayScore">—</span>
            <span class="score-sep">—</span>
            <span class="score-num" id="homeScore">—</span>
          </div>

          <!-- Shot clock visualization -->
          <div class="shot-clock" id="shotClock" style="display:none;">
            <div class="shot-clock-label">
              <span id="awayShotsLabel">Away: 0</span>
              <span id="homeShotsLabel">Home: 0</span>
            </div>
            <div class="shot-bar-container">
              <div class="shot-bar-away" id="shotBarAway" style="width:50%"></div>
              <div class="shot-bar-home" id="shotBarHome" style="width:50%"></div>
            </div>
          </div>

          <div class="mid-meta">
            <div class="state" id="state">Loading…</div>
            <div><span class="pill" id="when"></span></div>
            <div class="muted" id="updated"></div>
          </div>
        </div>

        <!-- Home -->
        <div class="team home" id="homeTeam">
          <div class="team-name-row">
            <div class="badge" id="homeBadge"></div>
            <div class="name">Home</div>
          </div>

          <div class="team-metrics" id="homeMetrics">
            <div class="metric"><b>SOG</b>: <span id="homeSog">—</span></div>
            <div class="metric"><b>Hits</b>: <span id="homeHits">—</span></div>
            <div class="metric"><b>Blk</b>: <span id="homeBlocks">—</span></div>
            <div class="metric"><b>G</b>: <span id="homeGoalie">—</span></div>
          </div>
        </div>
      </div>

      <!-- Live Goals -->
      <div class="panel" id="liveGoalsPanel" style="margin-top:0;">
        <h3>Goals</h3>
        <div class="goals" id="goals"><div class="loading">Loading goals…</div></div>
      </div>
    </div>

    <!-- Most Recent Game -->
    <div class="panel" id="lastGamePanel">
      <h3>Most Recent Game</h3>
      <div id="lastGameBox" class="loading">Loading…</div>
      <div class="goals" id="lastGameGoals"></div>
    </div>

    <!-- Next Game -->
    <div class="panel" id="nextGamePanel">
      <h3>Next Game</h3>
      <div id="nextGameBox" class="loading">Loading…</div>
    </div>
  </div>

<script>
(async function(){
  const SABRES_ABBR = 'BUF';
  const CORS_PROXY = 'https://corsproxy.io/?';

  const setTxt = (id, t) => {
    const el = document.getElementById(id);
    if (el) el.textContent = t;
  };

  const setHTML = (id, html) => {
    const el = document.getElementById(id);
    if (el) el.innerHTML = html;
  };

  function formatDate(dateStr) {
    try {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', {
        timeZone: 'America/New_York',
        weekday: 'short',
        month: 'short',
        day: 'numeric',
        hour: 'numeric',
        minute: '2-digit'
      });
    } catch {
      return dateStr;
    }
  }

  function getTeamLogo(abbr) {
    return `https://assets.nhle.com/logos/nhl/svg/${abbr}_light.svg`;
  }

  function teamLabel(t) {
    return t?.placeName?.default || t?.commonName?.default || t?.name?.default || t?.abbrev || '';
  }

  function setUpdatedNow() {
    const el = document.getElementById('updated');
    if (!el) return;
    el.textContent = `Updated ${new Date().toLocaleTimeString('en-US', {
      timeZone: 'America/New_York',
      hour: 'numeric',
      minute: '2-digit',
      second: '2-digit'
    })}`;
  }

  async function fetchJSON(url) {
    const proxiedUrl = CORS_PROXY + encodeURIComponent(url);
    const response = await fetch(proxiedUrl, { cache: 'no-store' });
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    return await response.json();
  }

  function firstDefined(...vals) {
    for (const v of vals) {
      if (v !== undefined && v !== null) return v;
    }
    return undefined;
  }

  function formatSavePctDot(v) {
    if (v == null) return '—';
    const s = (typeof v === 'string') ? v.trim().replace('%','') : v;
    let num = (typeof s === 'number') ? s : Number(s);
    if (!Number.isFinite(num)) return '—';
    if (num > 1.5) num = num / 100;
    return `.${String(Math.round(num * 1000)).padStart(3,'0')}`;
  }

  // FIXED: Priority-based goalie finder
  function findLikelyGoalie(side, box) {
    // Priority 1: playerByGameStats (most reliable)
    const pgStats = box?.playerByGameStats;
    if (pgStats) {
      const teamStats = side === 'away' ? pgStats.awayTeam : pgStats.homeTeam;
      const goalies = teamStats?.goalies;
      if (Array.isArray(goalies) && goalies.length > 0) {
        return goalies[0];
      }
    }
    
    // Priority 2: Direct team path
    const t = side === 'away' ? box?.awayTeam : box?.homeTeam;
    if (t?.goalies && Array.isArray(t.goalies) && t.goalies.length > 0) {
      return t.goalies[0];
    }
    
    // Priority 3: Search in all players
    const allPlayers = t?.players || [];
    const goalie = allPlayers.find(p => 
      (p.positionCode || p.position) === 'G'
    );
    
    return goalie || null;
  }

  function goalieLabel(g) {
    if (!g) return '—';
    const ln = g.lastName?.default || g.lastName || '';
    const name = ln ? ln : (g.name?.default || g.name || 'Goalie');

    const svRaw = firstDefined(
      g.savePctg, g.savePercentage, g.savePct, g.svPct, 
      g.savePctgDecimal, g.savePctgValue, g.savePctValue
    );

    let sv = null;
    if (svRaw != null) {
      sv = formatSavePctDot(svRaw);
    } else {
      const saves = firstDefined(g.saves, g.savesAgainst, g.totalSaves);
      const sa = firstDefined(g.shotsAgainst, g.shotsFaced, g.shots, g.sa);
      const savesNum = Number(saves);
      const saNum = Number(sa);
      if (Number.isFinite(savesNum) && Number.isFinite(saNum) && saNum > 0) {
        sv = formatSavePctDot(savesNum / saNum);
      }
    }

    return `${name} (${sv ?? '—'})`;
  }

  // FIXED: Priority-based team stat extraction
  function extractTeamStat(side, box, statName) {
    // Priority 1: playerByGameStats
    const pgStats = box?.playerByGameStats;
    if (pgStats) {
      const teamStats = side === 'away' ? pgStats.awayTeam : pgStats.homeTeam;
      if (teamStats) {
        const value = teamStats[statName];
        if (value !== undefined && value !== null) return value;
      }
    }
    
    // Priority 2: Direct team object
    const team = side === 'away' ? box?.awayTeam : box?.homeTeam;
    if (team) {
      const value = team[statName];
      if (value !== undefined && value !== null) return value;
    }
    
    return null;
  }

  function applyTeamMetrics(side, box) {
    const sog = extractTeamStat(side, box, 'sog');
    const hits = extractTeamStat(side, box, 'hits');
    const blocks = extractTeamStat(side, box, 'blockedShots');
    const goalie = findLikelyGoalie(side, box);

    setTxt(side + 'Sog', sog != null ? String(sog) : '—');
    setTxt(side + 'Hits', hits != null ? String(hits) : '—');
    setTxt(side + 'Blocks', blocks != null ? String(blocks) : '—');
    setTxt(side + 'Goalie', goalieLabel(goalie));
  }

  // Color-code scores and show shot clock
  function updateScoreDisplay(awayScore, homeScore, isSabresHome, awaySog, homeSog) {
    const awayEl = document.getElementById('awayScore');
    const homeEl = document.getElementById('homeScore');
    
    awayEl.textContent = awayScore;
    homeEl.textContent = homeScore;

    // Color coding based on who's winning
    if (isSabresHome) {
      if (homeScore > awayScore) {
        homeEl.className = 'score-num winning';
        awayEl.className = 'score-num losing';
      } else if (awayScore > homeScore) {
        awayEl.className = 'score-num winning';
        homeEl.className = 'score-num losing';
      } else {
        awayEl.className = 'score-num';
        homeEl.className = 'score-num';
      }
    } else {
      if (awayScore > homeScore) {
        awayEl.className = 'score-num winning';
        homeEl.className = 'score-num losing';
      } else if (homeScore > awayScore) {
        homeEl.className = 'score-num winning';
        awayEl.className = 'score-num losing';
      } else {
        awayEl.className = 'score-num';
        homeEl.className = 'score-num';
      }
    }

    // Shot clock visualization
    if (awaySog != null && homeSog != null) {
      document.getElementById('shotClock').style.display = 'block';
      setTxt('awayShotsLabel', `Away: ${awaySog}`);
      setTxt('homeShotsLabel', `Home: ${homeSog}`);
      
      const total = awaySog + homeSog;
      if (total > 0) {
        const awayPct = (awaySog / total) * 100;
        const homePct = (homeSog / total) * 100;
        document.getElementById('shotBarAway').style.width = `${awayPct}%`;
        document.getElementById('shotBarHome').style.width = `${homePct}%`;
      }
    } else {
      document.getElementById('shotClock').style.display = 'none';
    }
  }

  // Show penalty information
  function updatePenaltyInfo(details) {
    const penaltyBox = document.getElementById('penaltyBox');
    
    // Check for active penalties/power play
    const situation = details?.situation;
    if (situation && (situation.awayPowerPlay || situation.homePowerPlay)) {
      penaltyBox.classList.add('active');
      
      const ppTeam = situation.awayPowerPlay ? 'Away' : 'Home';
      const timeRemaining = situation.timeRemaining || '—';
      
      setTxt('penaltyTeam', ppTeam);
      setTxt('penaltyTimer', timeRemaining);
    } else {
      penaltyBox.classList.remove('
